{%- set pget = salt['pillar.get'] -%}
{%- set default_realm = salt['grains.get']('domain').upper() -%}
{%- set mainrealm = pget('kerberos:mainrealm', default_realm) -%}
{%- set kdc_ldap = pget('kerberos:install-kdc-ldap', False) -%}
[libdefaults]
	default_realm = {{ mainrealm }}

# The following krb5.conf variables are only for MIT Kerberos.
	krb4_config = /etc/krb.conf
	krb4_realms = /etc/krb.realms
	kdc_timesync = 1
	ccache_type = 4
	forwardable = true
	proxiable = true

# The following encryption type specification will be used by MIT Kerberos
# if uncommented.  In general, the defaults in the MIT Kerberos code are
# correct and overriding these specifications only serves to disable new
# encryption types as they are added, creating interoperability problems.
#
# Thie only time when you might need to uncomment these lines and change
# the enctypes is if you have local software that will break on ticket
# caches containing ticket encryption types it doesn't know about (such as
# old versions of Sun Java).

#	default_tgs_enctypes = des3-hmac-sha1
#	default_tkt_enctypes = des3-hmac-sha1
#	permitted_enctypes = des3-hmac-sha1

# The following libdefaults parameters are only for Heimdal Kerberos.
	v4_instance_resolve = false
	v4_name_convert = {
		host = {
			rcmd = host
			ftp = ftp
		}
		plain = {
			something = something-else
		}
	}
	fcc-mit-ticketflags = true

[realms]
	{{ mainrealm }} = {
		kdc = {{ pget('kerberos:kdc', salt['grains.get']('fqdn')) }}
		admin_server = {{ pget('kerberos:admin_server', salt['grains.get']('fqdn')) }}
		{% if kdc_ldap %}
		database_module = LDAP
		{% endif %}
			  }


[domain_realm]
	.{{ mainrealm.lower() }} = {{ mainrealm }}
	{{ mainrealm.lower() }} = {{ mainrealm }}

[login]
	krb4_convert = true
	krb4_get_tickets = false

# https://www.debian-administration.org/article/570/MIT_Kerberos_installation_on_Debian
[logging]
	kdc = FILE:/var/log/kerberos/krb5kdc.log
	admin_server = FILE:/var/log/kerberos/kadmin.log
	default = FILE:/var/log/kerberos/krb5lib.log

{% if kdc_ldap %}
# https://wiki.debian.org/DebianLAN
[dbdefaults]
        ldap_kerberos_container_dn = {{ pget('kerberos:ldap_container') }}

[dbmodules]
        LDAP = {
              db_library = kldap
              ldap_kerberos_container_dn = {{ pget('kerberos:ldap_container') }}
              ldap_kdc_dn = cn=kdc,{{ pget('kerberos:ldap_container') }}
              ldap_kadmind_dn = cn=kadmin,{{ pget('kerberos:ldap_container') }}
              ldap_service_password_file = /etc/krb5kdc/service.keyfile
              ldap_servers = ldapi://
              ldap_conns_per_server = 5
       }
{% endif %}       